<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Agregar Cargas - DMO Cargas</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="./assets/normalize.css">
    <link rel="stylesheet" href="./assets/libs/bootstrap-5.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="./assets/styles.css">
    <script src="https://kit.fontawesome.com/a40ecc8ef9.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-navigation">
        <!--navbar-navigation la cree yo, esta en styles.css-->
        <div class="container-fluid">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item mt-1">
                    <p class="parr_volver"><i class="fa-solid fa-circle-left"></i><a class="nav-link d-inline" style="margin-left: 10px; color: #241F74;">Volver</a></p>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container add_freights">
        <form class="formulario_freight" autocomplete="off" id="form_freight">

            <!-- Grupo: Usuario -->
            <div class="formulario_grupo d-none" id="grupo__cod_usuario">
                <!--  hidden="true" para el grupo de usuario -->
                <label for="cod_usuario" class="form__label">Usuario</label>
                <div class="form__grupo_input">
                    <input type="text" class="form__input form-control" id="cod_usuario" name="cod_usuario">
                </div>
            </div>

            <!-- Grupo: Tipo Carga -->
            <div class="formulario_grupo d-none" id="grupo__cod_tipo_carga">
                <label for="cod_tipo_carga" class="form__label">Tipo Carga</label>
                <div class="form__grupo_input">
                    <input type="text" class="form__input form-control" id="cod_tipo_carga" name="cod_tipo_carga">
                </div>
            </div>

            <!-- Grupo: Fecha Publicación Carga -->
            <div class="formulario_grupo d-none" id="grupo__fec_publicacion" style="display: inline-block;">
                <label for="fec_publicacion" class="form__label">Fecha Publicación</label>
                <div class="form__grupo_input">
                    <input type="date" class="form__input form-control" id="fec_publicacion" name="fec_publicacion">
                </div>
            </div>

            <!-- Grupo: Origen -->
            <div class="formulario_grupo" id="grupo__origen" style="display: block;">
                <label for="origen" class="form__label">Ciudad Origen</label>
                <div class="form__grupo_input">
                    <input type="text" placeholder="Elija un Origen" class="form__input form-control" id="origen" name="origen">
                </div>
            </div>

            <!-- Grupo: Domicilio Origen -->
            <div class="formulario_grupo" id="grupo__domicilio_origen" style="display: inline-block;">
                <label for="domicilio_origen" class="form__label">Domicilio</label>
                <div class="form__grupo_input">
                    <input type="text" placeholder="Calle + Número" class="form__input form-control" id="domicilio_origen" name="domicilio_origen">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Calle + Nro sin puntos ni comas</p>
            </div>

            <!-- Grupo: Fecha Retiro -->
            <div class="formulario_grupo" id="grupo__fec_retiro" style="display: inline-block;">
                <label for="fec_retiro" class="form__label">Fecha Retiro</label>
                <div class="form__grupo_input">
                    <input type="date" class="form__input form-control" id="fec_retiro" name="fec_retiro">
                </div>
                <p class="form__input_error">Debe ingresar una Fecha</p>
            </div>

            <!-- Grupo: Hora Retiro -->
            <div class="formulario_grupo" id="grupo__hora_retiro" style="display: inline-block;">
                <label for="hora_retiro" class="form__label">Hora Estimada</label>
                <div class="form__grupo_input">
                    <input type="time" class="form__input form-control" id="hora_retiro" name="hora_retiro">
                </div>
            </div>
            <hr>
            <!-- Grupo: Estado -->
            <div class="formulario_grupo d-none" id="" style="grid-column: span 3;">
                <label for="selectEstadoCarga" class="form__label">Estado</label>
                <div class="form__grupo_input">
                    <select class="selectTipoProducto" name="cod_estado_carga" id="selectEstadoCarga">                                                
                    </select>
                </div>
            </div>

            <!-- Grupo: Tipo Producto -->
            <div class="formulario_grupo" id="" style="grid-column: span 3;">
                <label for="selectTipoProducto" class="form__label">Tipo Producto</label>
                <div class="form__grupo_input">
                    <select class="selectTipoProducto" name="cod_tipo_producto" id="selectTipoProducto">
                        <option id="option_tipo_prod_0" value="0">Seleccione un producto...</option>
                    </select>
                </div>
            </div>

            <!-- Grupo: Req. Refrigeracion -->
            <div class="formulario_grupo form_req_refrigeracion" id="grupo__req_refrigeracion">
                <label for="" class="form__label">                
                    <input type="checkbox" value="true" id="req_refrigeracion" name="req_refrigeracion"> Requiere Refrigeración
                </label>
            </div>

            <!-- Grupo: Carga Peligrosa -->
            <div class="formulario_grupo form_es_carga_peligrosa" id="grupo__es_carga_peligrosa">
                <label for="" class="form__label">                
                    <input type="checkbox" value="true" id="es_carga_peligrosa" name="es_carga_peligrosa"> Carga Peligrosa
                </label>
            </div>

            <!-- Grupo: Carga Apilable -->
            <div class="formulario_grupo form_es_carga_apilable" id="grupo__es_carga_apilable">
                <label for="" class="form__label">                
                    <input type="checkbox" value="true" id="es_carga_apilable" name="es_carga_apilable"> Carga Apilable
                </label>
            </div>

            <!-- Grupo: Cant. Unitaria -->
            <div class="formulario_grupo form_cant_unit" id="grupo__cant_unit">
                <label for="cant_unit" class="form__label">Cant. Unitaria</label>
                <div class="form__grupo_input">
                    <input type="number" placeholder="En Unidades" class="form__input form-control" id="cant_unit" name="cant_unit">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Peso Unitario KG -->
            <div class="formulario_grupo form_peso_unit_kg" id="grupo__peso_unit_kg">
                <label for="peso_unit_kg" class="form__label">Peso Unitario (Kg)</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" placeholder="Kilogramos" class="form__input form-control" id="peso_unit_kg" name="peso_unit_kg">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Peso Total KG -->
            <div class="formulario_grupo form_peso_total_kg" id="grupo__peso_total_kg">
                <label for="peso_total_kg" class="form__label">Peso Total (Kg)</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" placeholder="Kilogramos" class="form__input form-control" id="peso_total_kg" name="peso_total_kg">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Largo -->
            <div class="formulario_grupo form_largo_mts" id="grupo__largo_mts">
                <label for="largo_mts" class="form__label">Largo (Metros)</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" placeholder="Metros" class="form__input form-control" id="largo_mts" name="largo_mts">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Ancho -->
            <div class="formulario_grupo form_ancho_mts" id="grupo__ancho_mts">
                <label for="ancho_mts" class="form__label">Ancho (Metros)</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" placeholder="Metros" class="form__input form-control" id="ancho_mts" name="ancho_mts">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Alto -->
            <div class="formulario_grupo form_alto_mts" id="grupo__alto_mts">
                <label for="alto_mts" class="form__label">Alto (Metros)</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" placeholder="Metros" class="form__input form-control" id="alto_mts" name="alto_mts">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Peso Unitario TN -->
            <div class="formulario_grupo form_peso_unit_tn" id="grupo__peso_unit_tn">
                <label for="peso_unit_tn" class="form__label">Peso Unitario (Tn)</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" placeholder="Toneladas" class="form__input form-control" id="peso_unit_tn" name="peso_unit_tn">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Peso Total TN -->
            <div class="formulario_grupo form_peso_total_tn" id="grupo__peso_total_tn">
                <label for="peso_total_tn" class="form__label">Peso Total (Tn)</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" placeholder="Toneladas" class="form__input form-control" id="peso_total_tn" name="peso_total_tn">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Cant. Litros -->
            <div class="formulario_grupo form_cant_litros" id="grupo__cant_litros">
                <label for="cant_litros" class="form__label">Cantidad Litros</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" placeholder="Litros" class="form__input form-control" id="cant_litros" name="cant_litros">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Dato inválido</p>
            </div>

            <!-- Grupo: Comentario -->
            <div class="formulario_grupo" id="grupo__comentario" style="grid-column: span 3;">
                <label for="comentario" class="form__label">Comentario</label>
                <div class="form__grupo_input">
                    <input type="text" placeholder="Opcional" class="form__input form-control" id="comentario" name="comentario">
                </div>
            </div>


            <hr>

            <!-- Grupo: Destino -->
            <div class="formulario_grupo" id="grupo__destino" style="display: block;">
                <label for="destino" class="form__label">Ciudad Destino</label>
                <div class="form__grupo_input">
                    <input type="text" placeholder="Elija un destino" class="form__input form-control" id="destino" name="destino">
                </div>
            </div>

            <!-- Grupo: Domicilio Destino -->
            <div class="formulario_grupo" id="grupo__domicilio_destino" style="display: inline-block;">
                <label for="domicilio_destino" class="form__label">Domicilio</label>
                <div class="form__grupo_input">
                    <input type="text" placeholder="Calle + Número" class="form__input form-control" id="domicilio_destino" name="domicilio_destino">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Calle + Nro sin puntos ni comas</p>
            </div>

            <!-- Grupo: Receptor de Carga -->
            <div class="formulario_grupo" id="grupo__receptor_carga" style="display: inline-block;">
                <label for="receptor_carga" class="form__label">Receptor</label>
                <div class="form__grupo_input">
                    <input type="text" placeholder="Quién reciba la carga" class="form__input form-control" id="receptor_carga" name="receptor_carga">
                    <i class="form__validacion_estado fa-solid fa-circle-xmark"></i>
                </div>
                <p class="form__input_error">Debe ingresar un Receptor de la Carga</p>
            </div>

            <hr>

            <button class="btn_calcular_valor" id="btn_calcular_valor">Calcular Valor de la Carga</button>

            <!-- Grupo: Distancia Recorrido -->
            <div class="formulario_grupo mt-4" id="grupo__distancia_recorrido">
                <div class="">
                    <input type="number" class="form__input form-control" id="distancia_recorrido" name="distancia_recorrido" hidden>
                    <p id="parrafo_dist_recorrido"></p>
                </div>
            </div>

            <!-- Grupo: Fecha Llegada -->
            <div class="formulario_grupo" id="grupo__fec_destino" style="display: inline-block;">
                <!--El name es para JS, class para CSS el, el id para JS y tbm para el label for-->
                <label for="fec_destino" class="form__label">Fecha estimada de llegada</label>
                <div class="form__grupo_input">
                    <input type="date" class="form__input form-control" id="fec_destino" name="fec_destino" disabled>
                </div>
            </div>

            <!-- Grupo: Valor Carga -->
            <div class="formulario_grupo" id="grupo__valor_carga" style="display: inline-block;">
                <label for="valor_carga" class="form__label">Valor Flete de la Carga</label>
                <div class="form__grupo_input">
                    <input type="number" step="0.01" class="form__input form-control" id="valor_carga" name="valor_carga" hidden>
                    <input type="text" class="form__input form-control" id="valor_carga_en_pesos" name="" disabled>
                </div>
            </div>

            <div class="formulario_grupo form__grupo-btn-agregar-carga">
                <div class="form__mensaje_error" id="form__mensaje_error">
                    <p><i class="fa-solid fa-triangle-exclamation"></i> <b>Error:</b> Datos Incorrectos/Incompletos</p>
                </div>
                <button type="submit" name="" id="btn-agregaCarga" class="btn form_btn mt-3 mb-3 btn-agregaCarga">Agregar Carga</button>
            </div>
        </form>


    </div>
    <script src="./assets/libs/bootstrap-5.2.0/js/bootstrap.min.js "></script>
    <script src="./add_freight.js "></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNlsS5ZWXx_l8kzgjGyRRZ8uJ0YodeYyE&libraries=places&callback=initAutoCompleteDistance"></script>
    <script>
        const input_place_origin = document.getElementById("origen"),
            input_place_destination = document.getElementById("destino"),
            btn_calcula_valor = document.getElementById("btn_calcular_valor"),
            input_valor_carga = document.getElementById("valor_carga"),
            input_valor_carga_pesos = document.getElementById("valor_carga_en_pesos"),
            input_distancia_recorrido = document.getElementById("distancia_recorrido"),
            parr_dist_recorrido = document.getElementById("parrafo_dist_recorrido"),
            valor_km_recorrido = 100,
            valor_unit_tn = 1500,
            valor_unit_kg = 1.5,
            valor_litro = 200,
            selectProducto = document.getElementById("selectTipoProducto"),
            peso_total_kg = document.getElementById("peso_total_kg"),
            peso_total_tn = document.getElementById("peso_total_tn"),
            cant_litros = document.getElementById("cant_litros");

        let autocompleteOrigin,
            autocompleteDestination,
            placeID_Origen,
            placeID_destino;

        function initAutoCompleteDistance() {
            autocompleteOrigin = new google.maps.places.Autocomplete(input_place_origin);
            autocompleteDestination = new google.maps.places.Autocomplete(input_place_destination);
            autocompleteOrigin.addListener('place_changed', function() {
                const placeOrigin = autocompleteOrigin.getPlace();
                placeID_Origen = placeOrigin.place_id;
                //console.log(placeID_Origen);
            });
            autocompleteDestination.addListener('place_changed', function() {
                const placeDestination = autocompleteDestination.getPlace();
                placeID_destino = placeDestination.place_id;

            })
        }

        function sumarDias(fecha, dias) {
            fecha.setDate(fecha.getDate() + dias);
            return fecha;
        }

        btn_calcula_valor.addEventListener("click", (event) => {
            event.preventDefault();
            const config = {
                method: 'get',
                url: `https://maps.googleapis.com/maps/api/distancematrix/json?origins=place_id:${placeID_Origen}&destinations=place_id:${placeID_destino}&key=AIzaSyCNlsS5ZWXx_l8kzgjGyRRZ8uJ0YodeYyE`,
            };

            if (selectProducto.value == 0) {
                alert("Debe elegir un Tipo de Producto")
            } else {
                if (peso_total_kg.value == "" || peso_total_tn.value == "" || cant_litros.value == "") {
                    alert("¡Datos Incorrectos/Incompletos!")
                } else {
                    axios(config)
                        .then(function(response) {
                            let data = JSON.stringify(response.data),
                                datos = JSON.parse(data),
                                distancia_km = datos.rows[0].elements[0].distance.text.replace(".", ""),
                                distancia_tiempo = datos.rows[0].elements[0].duration.text.split(" "),
                                pais_origen = datos.origin_addresses[0].split(","),
                                pais_destino = datos.destination_addresses[0].split(",");
                            console.log("datos", datos);
                            console.log("Distancia: ", datos.rows[0].elements[0].distance.text);
                            console.log("distancia_tiempo", distancia_tiempo);



                            //Deje el espacio adelante de Argentina porque total siempre lo arma con el espacio, debido a que antes hay una coma 
                            if (pais_origen.includes(' Argentina') && pais_destino.includes(' Argentina')) {
                                if (peso_total_kg.value != 0) {
                                    let valor1 = (parseFloat(peso_total_kg.value) * valor_unit_kg),
                                        valor2 = (valor_km_recorrido * parseFloat(distancia_km));
                                    input_valor_carga.value = valor1 + valor2;
                                    input_valor_carga_pesos.value = new Intl.NumberFormat('es-AR', {
                                        style: 'currency',
                                        currency: 'ARS'
                                    }).format(input_valor_carga.value);
                                }
                                if (peso_total_tn.value != 0) {
                                    console.log(parseFloat(peso_total_tn.value));
                                    let valor1 = (parseFloat(peso_total_tn.value) * valor_unit_tn),
                                        valor2 = (valor_km_recorrido * parseFloat(distancia_km));
                                    input_valor_carga.value = (valor1 + valor2);
                                    input_valor_carga_pesos.value = new Intl.NumberFormat('es-AR', {
                                        style: 'currency',
                                        currency: 'ARS'
                                    }).format(input_valor_carga.value);
                                }
                                if (cant_litros.value != 0) {
                                    let valor1 = (parseFloat(cant_litros.value) * valor_litro),
                                        valor2 = (valor_km_recorrido * parseFloat(distancia_km));
                                    input_valor_carga.value = valor1 + valor2;
                                    input_valor_carga_pesos.value = new Intl.NumberFormat('es-AR', {
                                        style: 'currency',
                                        currency: 'ARS'
                                    }).format(input_valor_carga.value);
                                }


                                console.log(input_valor_carga.value, input_valor_carga_pesos.value);


                                input_distancia_recorrido.value = parseFloat(distancia_km);
                                parr_dist_recorrido.innerHTML = `<b>Distancia Estimada del recorrido: </b> ${datos.rows[0].elements[0].distance.text}`;

                                let fec_retiro = new Date(document.getElementById("fec_retiro").value),
                                    dias = 0;


                                if (!distancia_tiempo.includes('min')) {

                                    if (distancia_tiempo.includes('día') || distancia_tiempo.includes('días')) {
                                        dias = (parseInt(distancia_tiempo[0]) * 2) + 1;
                                    } else {
                                        dias = parseInt(distancia_tiempo[0] / 12, 10) + 1;
                                    }
                                } else {

                                    dias = 1;
                                }
                                console.log(dias);


                                var fec_ret = new Date(sumarDias(fec_retiro, dias)),
                                    day = fec_ret.getDate(),
                                    month = fec_ret.getMonth() + 1,
                                    year = fec_ret.getFullYear();

                                if (`${month}`.length > 1 && `${day}`.length > 1) {
                                    document.getElementById("fec_destino").value = `${year}-${month}-${day}`;
                                } else if (`${month}`.length == 1 && `${day}`.length == 1) {
                                    document.getElementById("fec_destino").value = `${year}-0${month}-0${day}`;
                                } else if (`${month}`.length == 1) {
                                    document.getElementById("fec_destino").value = `${year}-0${month}-${day}`;
                                } else if (`${day}`.length == 1) {
                                    document.getElementById("fec_destino").value = `${year}-${month}-0${day}`;
                                }

                                console.log(document.getElementById("fec_destino").value)
                            } else {
                                alert("¡Ha ingresado Localidades Fuera de Argentina o ha ingresado mal la localidad!")
                            }
                        })
                        .catch(function(error) {
                            console.log(error);
                            //Por defecto esta API tiene transporte terrestre, si no especifico otro tipo de transporte e ingreso localidades como origen: Argentina y destino: USA entonces no lo calcula y tira error
                            alert("¡No se puede llegar a esa localidad vía terrestre!")
                        });
                }

            }
        })
    </script>


</body>

</html>